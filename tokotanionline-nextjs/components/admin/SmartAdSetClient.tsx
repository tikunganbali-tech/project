'use client';

import { useState, useEffect } from 'react';
import * as XLSX from 'xlsx';
import {
  Target,
  TrendingUp,
  DollarSign,
  Users,
  MapPin,
  Smartphone,
  Brain,
  Award,
  AlertCircle,
  CheckCircle,
  Download,
  RefreshCw,
  Eye,
  Zap,
  BarChart3,
} from 'lucide-react';
// Notification utility removed - using simple alerts

interface SmartAdSet {
  adSetId: string;
  adSetName: string;
  platform?: 'google' | 'facebook' | 'tiktok' | 'all';
  targetAudience: {
    segmentName: string;
    interests: string[];
    demographics: {
      location: string[];
      deviceTypes: string[];
    };
    purchasingPower: string;
    engagementScore: number;
    conversionProbability: number;
    estimatedLTV: number;
    traffic: number;
    quality: string;
  };
  keywords: string[];
  locations: string[];
  deviceTargeting: string[];
  interests: string[];
  googleInterests?: Array<{ interestId: string; interestName: string }>;
  facebookInterests?: Array<{ interestId: string; interestName: string }>;
  tiktokInterests?: Array<{ interestId: string; interestName: string }>;
  purchasingPower?: 'retail' | 'menengah' | 'high_class';
  budgetRecommendation: number;
  bidRecommendation: number;
  expectedCTR: number;
  expectedCPC: number;
  expectedCPA: number;
  qualityScore: number;
  winningScore?: number;
  predictedPerformance: string;
  estimatedReach: number;
  estimatedImpressions: number;
  estimatedConversions: number;
}

interface SmartAdSetData {
  keywords: Array<{
    keyword: string;
    searchVolume: number;
    interestCategories: string[];
    intent: string;
    buyerIntent: number;
    googleInterests?: Array<{ interestId: string; interestName: string; relevanceScore: number }>;
    facebookInterests?: Array<{ interestId: string; interestName: string; relevanceScore: number }>;
    tiktokInterests?: Array<{ interestId: string; interestName: string; relevanceScore: number }>;
  }>;
  devices: Array<{
    deviceType: string;
    deviceBrand?: string;
    deviceModel?: string;
    avgPrice?: number;
    minPrice?: number;
    maxPrice?: number;
    purchasingPower: string;
    category?: string;
    audienceSize: number;
    avgEngagement: number;
  }>;
  locations: Array<{
    location: string;
    locationType: string;
    traffic: number;
    engagementScore: number;
    avgTimeOnPage: number;
    returnVisitorRate: number;
    conversionRate: number;
    marketValue: string;
    recommendedBudget: number;
  }>;
  adSets: SmartAdSet[];
}

interface LocationRecommendation {
  id: string;
  location: string;
  locationType: 'country' | 'region' | 'city' | 'district';
  country?: string;
  region?: string;
  city?: string;
  district?: string;
  visitorCount: number;
  engagementScore: number;
  conversionSignal: number;
  weightedScore: number;
  priority: 'high' | 'medium' | 'test';
  recommendedBudget: number;
  estimatedReach: number;
  estimatedConversions: number;
  topKeywords: string[];
  topDevices: string[];
  avgTimeOnPage: number;
  scrollDepth: number;
  ctaClickRate: number;
  confidence: number;
}

export default function SmartAdSetClient() {
  const [loading, setLoading] = useState(true);
  const [data, setData] = useState<SmartAdSetData | null>(null);
  const [locationRecommendations, setLocationRecommendations] = useState<LocationRecommendation[]>([]);
  const [loadingRecommendations, setLoadingRecommendations] = useState(false);
  const [keywordIntentMappings, setKeywordIntentMappings] = useState<any[]>([]);
  const [loadingIntentMappings, setLoadingIntentMappings] = useState(false);
  const [analyzeKeyword, setAnalyzeKeyword] = useState('');
  const [audienceClusters, setAudienceClusters] = useState<any[]>([]);
  const [loadingClusters, setLoadingClusters] = useState(false);
  const [deviceInsights, setDeviceInsights] = useState<any[]>([]);
  const [loadingDeviceInsights, setLoadingDeviceInsights] = useState(false);
  const [autoGeneratedAdSets, setAutoGeneratedAdSets] = useState<any[]>([]);
  const [loadingAutoGenerate, setLoadingAutoGenerate] = useState(false);
  const [feedbackLoops, setFeedbackLoops] = useState<any[]>([]);
  const [loadingFeedbackLoop, setLoadingFeedbackLoop] = useState(false);
  const [unifiedAds, setUnifiedAds] = useState<any>(null);
  const [loadingUnified, setLoadingUnified] = useState(false);
  const [selectedTab, setSelectedTab] = useState<'overview' | 'keywords' | 'locations' | 'devices' | 'adsets' | 'location-intelligence' | 'keyword-intent' | 'audience-clusters' | 'device-segmentation' | 'auto-generate' | 'feedback-loop' | 'unified'>('overview');
  const [days, setDays] = useState(30);

  const fetchData = async () => {
    setLoading(true);
    try {
      const response = await fetch(`/api/admin/ads/smart-adset?type=full&days=${days}`);
      if (response.ok) {
        const result = await response.json();
        setData(result);
        
        // Show message if tables don't exist
        if (result.message) {
          console.warn(result.message);
        }
      } else {
        const errorData = await response.json();
        console.error('Error fetching smart ad set data:', errorData);
        // Set empty data structure
        setData({
          keywords: [],
          devices: [],
          locations: [],
          adSets: [],
        });
      }
    } catch (error) {
      console.error('Error fetching smart ad set data:', error);
      // Set empty data structure on error
      setData({
        keywords: [],
        devices: [],
        locations: [],
        adSets: [],
      });
    } finally {
      setLoading(false);
    }
  };

  const fetchLocationRecommendations = async (recalculate: boolean = false) => {
    setLoadingRecommendations(true);
    try {
      const url = recalculate 
        ? `/api/admin/ads/location-recommendations?recalculate=true&days=${days}`
        : `/api/admin/ads/location-recommendations`;
      const response = await fetch(url);
      if (response.ok) {
        const result = await response.json();
        setLocationRecommendations(result.recommendations || []);
      }
    } catch (error) {
      console.error('Error fetching location recommendations:', error);
    } finally {
      setLoadingRecommendations(false);
    }
  };

  const fetchKeywordIntentMappings = async () => {
    setLoadingIntentMappings(true);
    try {
      const response = await fetch('/api/admin/ads/keyword-intent');
      if (response.ok) {
        const result = await response.json();
        setKeywordIntentMappings(result.mappings || []);
      }
    } catch (error) {
      console.error('Error fetching keyword intent mappings:', error);
    } finally {
      setLoadingIntentMappings(false);
    }
  };

  const analyzeKeywordIntent = async () => {
    if (!analyzeKeyword.trim()) {
      alert('Please enter a keyword to analyze');
      return;
    }

    setLoadingIntentMappings(true);
    try {
      const response = await fetch('/api/admin/ads/keyword-intent', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          keywords: [analyzeKeyword.trim()],
          useOfficialAPI: false,
        }),
      });

      if (response.ok) {
        const result = await response.json();
        alert(`Keyword "${analyzeKeyword}" analyzed successfully!`);
        setAnalyzeKeyword('');
        await fetchKeywordIntentMappings();
      } else {
        const errorData = await response.json();
        alert(errorData.error || 'Failed to analyze keyword');
      }
    } catch (error: any) {
      console.error('Error analyzing keyword intent:', error);
      alert('Failed to analyze keyword intent');
    } finally {
      setLoadingIntentMappings(false);
    }
  };

  const fetchAudienceClusters = async () => {
    setLoadingClusters(true);
    try {
      const response = await fetch('/api/admin/ads/audience-clusters');
      if (response.ok) {
        const result = await response.json();
        setAudienceClusters(result.clusters || []);
      }
    } catch (error) {
      console.error('Error fetching audience clusters:', error);
    } finally {
      setLoadingClusters(false);
    }
  };

  const fetchDeviceInsights = async () => {
    setLoadingDeviceInsights(true);
    try {
      const response = await fetch('/api/admin/ads/device-segmentation');
      if (response.ok) {
        const result = await response.json();
        setDeviceInsights(result.insights || []);
      }
    } catch (error) {
      console.error('Error fetching device insights:', error);
    } finally {
      setLoadingDeviceInsights(false);
    }
  };

  const fetchAutoGeneratedAdSets = async () => {
    setLoadingAutoGenerate(true);
    try {
      const response = await fetch('/api/admin/ads/auto-generate');
      if (response.ok) {
        const result = await response.json();
        setAutoGeneratedAdSets(result.adSets || []);
      }
    } catch (error) {
      console.error('Error fetching auto-generated ad sets:', error);
    } finally {
      setLoadingAutoGenerate(false);
    }
  };

  useEffect(() => {
    fetchData();
    fetchLocationRecommendations();
    fetchKeywordIntentMappings();
    fetchAudienceClusters();
    fetchDeviceInsights();
    fetchAutoGeneratedAdSets();
    fetchFeedbackLoops();
    fetchUnifiedAds();
  }, [days]);

  const fetchUnifiedAds = async () => {
    setLoadingUnified(true);
    try {
      const response = await fetch('/api/admin/engines/unified?action=summary');
      if (response.ok) {
        const result = await response.json();
        setUnifiedAds(result);
      }
    } catch (error) {
      console.error('Error fetching unified Smart Ads:', error);
    } finally {
      setLoadingUnified(false);
    }
  };

  const fetchFeedbackLoops = async () => {
    setLoadingFeedbackLoop(true);
    try {
      const response = await fetch('/api/admin/ads/feedback-loop?limit=10');
      if (response.ok) {
        const result = await response.json();
        setFeedbackLoops(result.feedbackLoops || []);
      }
    } catch (error) {
      console.error('Error fetching feedback loops:', error);
    } finally {
      setLoadingFeedbackLoop(false);
    }
  };

  if (loading && !data) {
    return (
      <div className="p-6 flex items-center justify-center min-h-screen">
        <RefreshCw className="h-8 w-8 animate-spin text-gray-400" />
      </div>
    );
  }

  if (!data) {
    return (
      <div className="p-6">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
          <p className="text-red-600 font-semibold mb-2">Failed to load Smart Ad Set data</p>
          <p className="text-sm text-red-700">
            Please check if analytics tables exist. Run: <code className="bg-red-100 px-2 py-1 rounded">npx prisma migrate dev</code>
          </p>
        </div>
      </div>
    );
  }

  // Check if data is empty (tables might not exist)
  const hasNoData = data.keywords.length === 0 && data.devices.length === 0 && 
                    data.locations.length === 0 && data.adSets.length === 0;
  
  // Check if tables actually exist (from API response)
  // Default to true if not specified (assume tables exist unless explicitly stated otherwise)
  const dataAny = data as any; // Type assertion for optional fields
  const tablesExist = dataAny?.tablesExist !== false;
  const hasTableError = dataAny?.message?.includes('tables not found') || 
                        dataAny?.message?.includes('Analytics tables not found');
  const isTableMissing = dataAny?.tablesExist === false || hasTableError;

  const topAdSets = data.adSets.slice(0, 10);
  const totalBudget = data.adSets.reduce((sum, ad) => sum + ad.budgetRecommendation, 0);
  const avgQualityScore = data.adSets.length > 0
    ? data.adSets.reduce((sum, ad) => sum + ad.qualityScore, 0) / data.adSets.length
    : 0;
  const totalEstimatedConversions = data.adSets.reduce((sum, ad) => sum + ad.estimatedConversions, 0);

  return (
    <div className="p-4 md:p-6 space-y-4 md:space-y-6 max-w-full overflow-x-hidden">
      {/* Header */}
      <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div className="flex-shrink-0">
          <h1 className="text-2xl md:text-3xl font-bold text-gray-900 flex items-center gap-2">
            <Target className="w-6 h-6 md:w-8 md:h-8 text-purple-500" />
            Smart Ad Set
          </h1>
          <p className="text-sm md:text-base text-gray-600 mt-1">Intelligent ad targeting based on analytics data</p>
        </div>
        <div className="flex flex-col sm:flex-row gap-2 w-full md:w-auto">
          <select
            value={days}
            onChange={(e) => setDays(parseInt(e.target.value))}
            className="px-3 md:px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 text-sm w-full sm:w-auto"
          >
            <option value="7">Last 7 Days</option>
            <option value="14">Last 14 Days</option>
            <option value="30">Last 30 Days</option>
            <option value="60">Last 60 Days</option>
            <option value="90">Last 90 Days</option>
          </select>
          <button
            onClick={fetchData}
            disabled={loading}
            className="px-3 md:px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 flex items-center justify-center gap-2 text-sm whitespace-nowrap w-full sm:w-auto"
          >
            <RefreshCw className={`h-4 w-4 ${loading ? 'animate-spin' : ''}`} />
            Refresh
          </button>
          <button
            onClick={() => {
              if (!data) {
                alert('No data to export');
                return;
              }

              try {
                // Create a new workbook
                const workbook = XLSX.utils.book_new();

                // 1. Ad Sets Sheet
                if (data.adSets && data.adSets.length > 0) {
                  const adSetsData = data.adSets.map((adSet) => ({
                    'Ad Set ID': adSet.adSetId,
                    'Ad Set Name': adSet.adSetName,
                    'Platform': adSet.platform || 'all',
                    'Segment Name': adSet.targetAudience.segmentName,
                    'Quality Score': adSet.qualityScore,
                    'Winning Score': adSet.winningScore || '-',
                    'Predicted Performance': adSet.predictedPerformance,
                    'Budget Recommendation': adSet.budgetRecommendation,
                    'Bid Recommendation': adSet.bidRecommendation,
                    'Expected CTR (%)': adSet.expectedCTR,
                    'Expected CPC': adSet.expectedCPC,
                    'Expected CPA': adSet.expectedCPA,
                    'Estimated Reach': adSet.estimatedReach,
                    'Estimated Impressions': adSet.estimatedImpressions,
                    'Estimated Conversions': adSet.estimatedConversions,
                    'Engagement Score': adSet.targetAudience.engagementScore,
                    'Conversion Probability': adSet.targetAudience.conversionProbability,
                    'Estimated LTV': adSet.targetAudience.estimatedLTV,
                    'Traffic': adSet.targetAudience.traffic,
                    'Keywords': adSet.keywords.join('; '),
                    'Locations': adSet.locations.join('; '),
                    'Device Targeting': adSet.deviceTargeting.join('; '),
                    'Interests': adSet.interests.join('; '),
                    'Purchasing Power': adSet.purchasingPower || '-',
                  }));
                  const adSetsSheet = XLSX.utils.json_to_sheet(adSetsData);
                  XLSX.utils.book_append_sheet(workbook, adSetsSheet, 'Ad Sets');
                }

                // 2. Keywords Sheet
                if (data.keywords && data.keywords.length > 0) {
                  const keywordsData = data.keywords.map((kw) => ({
                    'Keyword': kw.keyword,
                    'Search Volume': kw.searchVolume,
                    'Buyer Intent': kw.buyerIntent,
                    'Intent': kw.intent,
                    'Interest Categories': kw.interestCategories.join('; '),
                  }));
                  const keywordsSheet = XLSX.utils.json_to_sheet(keywordsData);
                  XLSX.utils.book_append_sheet(workbook, keywordsSheet, 'Keywords');
                }

                // 3. Devices Sheet
                if (data.devices && data.devices.length > 0) {
                  const devicesData = data.devices.map((device) => ({
                    'Device Type': device.deviceType,
                    'Device Brand': device.deviceBrand || '-',
                    'Device Model': device.deviceModel || '-',
                    'Category': device.category || '-',
                    'Avg Price': device.avgPrice || '-',
                    'Min Price': device.minPrice || '-',
                    'Max Price': device.maxPrice || '-',
                    'Purchasing Power': device.purchasingPower,
                    'Audience Size': device.audienceSize,
                    'Avg Engagement': device.avgEngagement,
                  }));
                  const devicesSheet = XLSX.utils.json_to_sheet(devicesData);
                  XLSX.utils.book_append_sheet(workbook, devicesSheet, 'Devices');
                }

                // 4. Locations Sheet
                if (data.locations && data.locations.length > 0) {
                  const locationsData = data.locations.map((loc) => ({
                    'Location': loc.location,
                    'Location Type': loc.locationType,
                    'Traffic': loc.traffic,
                    'Engagement Score': loc.engagementScore,
                    'Avg Time on Page (s)': loc.avgTimeOnPage,
                    'Return Visitor Rate (%)': loc.returnVisitorRate,
                    'Conversion Rate (%)': loc.conversionRate,
                    'Market Value': loc.marketValue,
                    'Recommended Budget': loc.recommendedBudget,
                  }));
                  const locationsSheet = XLSX.utils.json_to_sheet(locationsData);
                  XLSX.utils.book_append_sheet(workbook, locationsSheet, 'Locations');
                }

                // 5. Summary Sheet
                const summaryData = [
                  { 'Metric': 'Total Ad Sets', 'Value': data.adSets?.length || 0 },
                  { 'Metric': 'Total Keywords', 'Value': data.keywords?.length || 0 },
                  { 'Metric': 'Total Devices', 'Value': data.devices?.length || 0 },
                  { 'Metric': 'Total Locations', 'Value': data.locations?.length || 0 },
                  { 'Metric': 'Export Date', 'Value': new Date().toLocaleString('id-ID') },
                ];
                const summarySheet = XLSX.utils.json_to_sheet(summaryData);
                XLSX.utils.book_append_sheet(workbook, summarySheet, 'Summary');

                // Generate filename with date
                const filename = `smart-adset-export-${new Date().toISOString().split('T')[0]}.xlsx`;

                // Write the file
                XLSX.writeFile(workbook, filename);
                alert(`Excel file exported successfully: ${filename}`);
              } catch (error: any) {
                console.error('Export error:', error);
                alert(`Error exporting to Excel: ${error.message || 'Unknown error'}`);
              }
            }}
            className="px-3 md:px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 flex items-center justify-center gap-2 text-sm whitespace-nowrap w-full sm:w-auto"
          >
            <Download className="h-4 w-4" />
            <span className="hidden sm:inline">Export to Excel</span>
            <span className="sm:hidden">Export</span>
          </button>
        </div>
      </div>

      {/* Migration Warning - Only show if tables are actually missing */}
      {isTableMissing && (
        <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
          <div className="flex items-start gap-3">
            <AlertCircle className="h-5 w-5 text-yellow-600 mt-0.5" />
            <div>
              <p className="font-semibold text-yellow-800 mb-1">Analytics Tables Not Found</p>
              <p className="text-sm text-yellow-700 mb-2">
                The analytics database tables have not been created yet. Please run the migration to enable Smart Ad Set features.
              </p>
              <code className="block bg-yellow-100 px-3 py-2 rounded text-sm text-yellow-900 mt-2">
                npx prisma db push
              </code>
              <p className="text-xs text-yellow-600 mt-2">
                After migration, tracking will start automatically and data will appear here.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* No Data Warning - Show when tables exist but no data yet */}
      {hasNoData && !isTableMissing && (
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
          <div className="flex items-start gap-3">
            <AlertCircle className="h-5 w-5 text-blue-600 mt-0.5" />
            <div>
              <p className="font-semibold text-blue-800 mb-1">No Analytics Data Yet</p>
              <p className="text-sm text-blue-700 mb-2">
                Analytics tables are ready, but no visitor data has been tracked yet. Data will appear here once visitors start browsing your website.
              </p>
              <p className="text-xs text-blue-600 mt-2">
                Make sure your website has the PageViewTracker component enabled to start collecting analytics data.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Summary Stats */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-white p-4 rounded-lg shadow">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-600">Ad Sets Generated</p>
              <p className="text-2xl font-bold text-gray-900">{data.adSets.length}</p>
            </div>
            <Target className="w-8 h-8 text-purple-500" />
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-600">Avg Quality Score</p>
              <p className="text-2xl font-bold text-gray-900">{avgQualityScore.toFixed(1)}</p>
            </div>
            <Award className="w-8 h-8 text-yellow-500" />
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-600">Total Budget</p>
              <p className="text-2xl font-bold text-gray-900">
                Rp {totalBudget.toLocaleString('id-ID')}
              </p>
            </div>
            <DollarSign className="w-8 h-8 text-green-500" />
          </div>
        </div>

        <div className="bg-white p-4 rounded-lg shadow">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-sm text-gray-600">Est. Conversions</p>
              <p className="text-2xl font-bold text-gray-900">{totalEstimatedConversions}</p>
            </div>
            <TrendingUp className="w-8 h-8 text-blue-500" />
          </div>
        </div>
      </div>

      {/* Tabs */}
      <div className="bg-white rounded-lg shadow border border-gray-100 overflow-hidden">
        <div className="border-b border-gray-200">
          <nav className="flex -mb-px overflow-x-auto scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-gray-100">
            {[
              { id: 'overview', label: 'Overview', icon: BarChart3 },
              { id: 'adsets', label: 'Ad Sets', icon: Target },
              { id: 'keywords', label: 'Keywords', icon: Brain },
              { id: 'locations', label: 'Locations', icon: MapPin },
              { id: 'devices', label: 'Devices', icon: Smartphone },
              { id: 'location-intelligence', label: 'Location Intel', icon: MapPin },
              { id: 'keyword-intent', label: 'Keyword Intent', icon: Brain },
              { id: 'audience-clusters', label: 'Audiences', icon: Users },
              { id: 'device-segmentation', label: 'Device Segment', icon: Smartphone },
              { id: 'auto-generate', label: 'Auto Generate', icon: Zap },
              { id: 'feedback-loop', label: 'Feedback', icon: RefreshCw },
              { id: 'unified', label: 'Unified', icon: Target },
            ].map((tab) => {
              const Icon = tab.icon;
              return (
                <button
                  key={tab.id}
                  onClick={() => setSelectedTab(tab.id as any)}
                  className={`px-3 md:px-4 lg:px-6 py-2 md:py-3 border-b-2 font-medium text-xs md:text-sm flex items-center gap-1 md:gap-2 whitespace-nowrap flex-shrink-0 transition-colors ${
                    selectedTab === tab.id
                      ? 'border-purple-500 text-purple-600 bg-purple-50'
                      : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 hover:bg-gray-50'
                  }`}
                >
                  <Icon className="h-3 w-3 md:h-4 md:w-4" />
                  <span className="hidden sm:inline">{tab.label}</span>
                  <span className="sm:hidden">{tab.label.split(' ')[0]}</span>
                </button>
              );
            })}
          </nav>
        </div>

        <div className="p-3 md:p-4 lg:p-6 overflow-x-hidden">
          {/* Overview Tab */}
          {selectedTab === 'overview' && (
            <div className="space-y-4 md:space-y-6">
              <div>
                <h2 className="text-lg md:text-xl font-bold mb-3 md:mb-4">Top Performing Ad Sets</h2>
                <div className="space-y-3">
                  {topAdSets.map((adSet) => (
                    <div
                      key={adSet.adSetId}
                      className="border border-gray-200 rounded-lg p-3 md:p-4 hover:shadow-md transition-all bg-white"
                    >
                      <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                        <div className="flex-1 min-w-0">
                          <div className="flex flex-col sm:flex-row sm:items-center gap-2 mb-2">
                            <h3 className="font-semibold text-base md:text-lg truncate">{adSet.adSetName}</h3>
                            <span
                              className={`px-2 py-1 rounded text-xs font-medium flex-shrink-0 ${
                                adSet.predictedPerformance === 'excellent'
                                  ? 'bg-green-100 text-green-700'
                                  : adSet.predictedPerformance === 'good'
                                  ? 'bg-blue-100 text-blue-700'
                                  : adSet.predictedPerformance === 'moderate'
                                  ? 'bg-yellow-100 text-yellow-700'
                                  : 'bg-red-100 text-red-700'
                              }`}
                            >
                              {adSet.predictedPerformance.toUpperCase()}
                            </span>
                          </div>
                          
                          <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mt-3">
                            <div>
                              <p className="text-xs text-gray-500">Quality Score</p>
                              <p className="font-bold text-base md:text-lg">{adSet.qualityScore.toFixed(1)}</p>
                            </div>
                            <div>
                              <p className="text-xs text-gray-500">Est. Reach</p>
                              <p className="font-bold text-base md:text-lg truncate">{adSet.estimatedReach.toLocaleString()}</p>
                            </div>
                            <div>
                              <p className="text-xs text-gray-500">Budget</p>
                              <p className="font-bold text-base md:text-lg truncate">Rp {adSet.budgetRecommendation.toLocaleString('id-ID')}</p>
                            </div>
                            <div>
                              <p className="text-xs text-gray-500">Est. Conversions</p>
                              <p className="font-bold text-base md:text-lg">{adSet.estimatedConversions}</p>
                            </div>
                          </div>

                          <div className="mt-3 flex flex-wrap gap-2">
                            <span className="text-xs bg-gray-100 px-2 py-1 rounded truncate max-w-full">
                              üìç {adSet.locations.slice(0, 3).join(', ')}
                            </span>
                            <span className="text-xs bg-gray-100 px-2 py-1 rounded truncate max-w-full">
                              üì± {adSet.deviceTargeting.join(', ')}
                            </span>
                            <span className="text-xs bg-gray-100 px-2 py-1 rounded truncate max-w-full">
                              üí∞ {adSet.targetAudience.purchasingPower}
                            </span>
                            <span className="text-xs bg-gray-100 px-2 py-1 rounded truncate max-w-full">
                              üéØ {adSet.keywords[0]}
                            </span>
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            </div>
          )}

          {/* Ad Sets Tab */}
          {selectedTab === 'adsets' && (
            <div className="overflow-x-hidden">
              {data.adSets.length === 0 ? (
                <div className="text-center py-8 md:py-12 text-gray-500">
                  <Target className="h-10 w-10 md:h-12 md:w-12 mx-auto mb-3 md:mb-4 text-gray-400" />
                  <p className="text-base md:text-lg font-semibold mb-2">No Ad Sets Generated</p>
                  <p className="text-sm px-4">Ad sets will be generated automatically once there is sufficient analytics data.</p>
                </div>
              ) : (
                <div className="space-y-3 md:space-y-4">
                  <div className="mb-3 md:mb-4 flex items-center justify-between">
                    <p className="text-sm text-gray-600">Total Ad Sets: <span className="font-semibold">{data.adSets.length}</span></p>
                  </div>
                  {data.adSets.map((adSet) => (
                <div key={adSet.adSetId} className="border border-gray-200 rounded-lg p-4 md:p-6 bg-white hover:shadow-md transition-all">
                  <div className="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-4 mb-4">
                    <div className="flex-1 min-w-0">
                      <div className="flex flex-col sm:flex-row sm:items-center gap-2 mb-2 flex-wrap">
                        <h3 className="text-lg md:text-xl font-bold truncate">{adSet.adSetName}</h3>
                        {adSet.platform && (
                          <span className={`px-2 py-1 rounded text-xs font-medium ${
                            adSet.platform === 'google' ? 'bg-blue-100 text-blue-700' :
                            adSet.platform === 'facebook' ? 'bg-indigo-100 text-indigo-700' :
                            adSet.platform === 'tiktok' ? 'bg-pink-100 text-pink-700' :
                            'bg-gray-100 text-gray-700'
                          }`}>
                            {adSet.platform.toUpperCase()}
                          </span>
                        )}
                        {adSet.purchasingPower && (
                          <span className={`px-2 py-1 rounded text-xs font-medium ${
                            adSet.purchasingPower === 'high_class' ? 'bg-purple-100 text-purple-700' :
                            adSet.purchasingPower === 'menengah' ? 'bg-yellow-100 text-yellow-700' :
                            'bg-gray-100 text-gray-700'
                          }`}>
                            {adSet.purchasingPower === 'high_class' ? 'High Class' : 
                             adSet.purchasingPower === 'menengah' ? 'Menengah' : 'Retail'}
                          </span>
                        )}
                        {adSet.winningScore !== undefined && (
                          <span className={`px-2 py-1 rounded text-xs font-medium ${
                            adSet.winningScore >= 80 ? 'bg-green-100 text-green-700' :
                            adSet.winningScore >= 60 ? 'bg-yellow-100 text-yellow-700' :
                            'bg-red-100 text-red-700'
                          }`}>
                            ‚≠ê {adSet.winningScore} Winning
                          </span>
                        )}
                      </div>
                      <p className="text-sm text-gray-600 mt-1">{adSet.targetAudience.segmentName}</p>
                    </div>
                    <div className="text-right flex-shrink-0">
                      <div className={`text-xl md:text-2xl font-bold ${
                        adSet.predictedPerformance === 'excellent' ? 'text-green-600' :
                        adSet.predictedPerformance === 'good' ? 'text-blue-600' :
                        adSet.predictedPerformance === 'moderate' ? 'text-yellow-600' :
                        'text-red-600'
                      }`}>
                        {adSet.qualityScore.toFixed(1)}
                      </div>
                      <p className="text-xs text-gray-500">Quality Score</p>
                      {adSet.winningScore !== undefined && (
                        <>
                          <div className={`text-xl font-bold mt-2 ${
                            adSet.winningScore >= 80 ? 'text-green-600' :
                            adSet.winningScore >= 60 ? 'text-yellow-600' :
                            'text-red-600'
                          }`}>
                            {adSet.winningScore}
                          </div>
                          <p className="text-xs text-gray-500">Winning Score</p>
                        </>
                      )}
                    </div>
                  </div>

                  <div className="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4 mb-4">
                    <div className="bg-gray-50 p-3 rounded">
                      <p className="text-xs text-gray-500">Budget</p>
                      <p className="font-bold text-sm md:text-base truncate">Rp {adSet.budgetRecommendation.toLocaleString('id-ID')}</p>
                    </div>
                    <div className="bg-gray-50 p-3 rounded">
                      <p className="text-xs text-gray-500">Bid</p>
                      <p className="font-bold text-sm md:text-base truncate">Rp {adSet.bidRecommendation.toLocaleString('id-ID')}</p>
                    </div>
                    <div className="bg-gray-50 p-3 rounded">
                      <p className="text-xs text-gray-500">Est. CTR</p>
                      <p className="font-bold">{adSet.expectedCTR.toFixed(2)}%</p>
                    </div>
                    <div className="bg-gray-50 p-3 rounded">
                      <p className="text-xs text-gray-500">Est. CPA</p>
                      <p className="font-bold">Rp {adSet.expectedCPA.toLocaleString('id-ID')}</p>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                      <p className="text-xs text-gray-500 mb-1">Keywords</p>
                      <div className="flex flex-wrap gap-1">
                        {adSet.keywords.map((kw, idx) => (
                          <span key={idx} className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                            {kw}
                          </span>
                        ))}
                      </div>
                    </div>
                    <div>
                      <p className="text-xs text-gray-500 mb-1">Locations</p>
                      <div className="flex flex-wrap gap-1">
                        {adSet.locations.slice(0, 3).map((loc, idx) => (
                          <span key={idx} className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">
                            {loc}
                          </span>
                        ))}
                      </div>
                    </div>
                    <div>
                      <p className="text-xs text-gray-500 mb-1">Devices</p>
                      <div className="flex flex-wrap gap-1">
                        {adSet.deviceTargeting.map((dev, idx) => (
                          <span key={idx} className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">
                            {dev}
                          </span>
                        ))}
                      </div>
                    </div>
                    <div>
                      <p className="text-xs text-gray-500 mb-1">Interests</p>
                      <div className="flex flex-wrap gap-1">
                        {adSet.interests.slice(0, 2).map((interest: any, idx: number) => (
                          <span key={idx} className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                            {interest}
                          </span>
                        ))}
                      </div>
                    </div>
                  </div>

                  {/* Platform-Specific Interests */}
                  {(adSet.googleInterests || adSet.facebookInterests || adSet.tiktokInterests) && (
                    <div className="mt-4 pt-4 border-t">
                      <p className="text-xs font-semibold text-gray-700 mb-2">Platform-Specific Interests:</p>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                        {adSet.googleInterests && adSet.googleInterests.length > 0 && (
                          <div>
                            <p className="text-xs text-blue-600 font-medium mb-1">Google Ads:</p>
                            <div className="flex flex-wrap gap-1">
                              {adSet.googleInterests.slice(0, 3).map((interest: any, idx: number) => (
                                <span key={idx} className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-200">
                                  {interest.interestName}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                        {adSet.facebookInterests && adSet.facebookInterests.length > 0 && (
                          <div>
                            <p className="text-xs text-indigo-600 font-medium mb-1">Facebook:</p>
                            <div className="flex flex-wrap gap-1">
                              {adSet.facebookInterests.slice(0, 3).map((interest: any, idx: number) => (
                                <span key={idx} className="text-xs bg-indigo-50 text-indigo-700 px-2 py-1 rounded border border-indigo-200">
                                  {interest.interestName}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                        {adSet.tiktokInterests && adSet.tiktokInterests.length > 0 && (
                          <div>
                            <p className="text-xs text-pink-600 font-medium mb-1">TikTok:</p>
                            <div className="flex flex-wrap gap-1">
                              {adSet.tiktokInterests.slice(0, 3).map((interest: any, idx: number) => (
                                <span key={idx} className="text-xs bg-pink-50 text-pink-700 px-2 py-1 rounded border border-pink-200">
                                  {interest.interestName}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    </div>
                  )}

                  <div className="grid grid-cols-3 gap-4 text-sm">
                    <div>
                      <p className="text-gray-500">Est. Reach</p>
                      <p className="font-bold">{adSet.estimatedReach.toLocaleString()}</p>
                    </div>
                    <div>
                      <p className="text-gray-500">Est. Impressions</p>
                      <p className="font-bold">{adSet.estimatedImpressions.toLocaleString()}</p>
                    </div>
                    <div>
                      <p className="text-gray-500">Est. Conversions</p>
                      <p className="font-bold">{adSet.estimatedConversions}</p>
                    </div>
                  </div>
                </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* Keywords Tab */}
          {selectedTab === 'keywords' && (
            <div>
              {data.keywords.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <Brain className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                  <p className="text-lg font-semibold mb-2">No Keyword Data Available</p>
                  <p className="text-sm">Analytics data will appear here once visitors start searching.</p>
                </div>
              ) : (
                <>
                  <div className="mb-4 flex items-center justify-between">
                    <p className="text-sm text-gray-600">Total Keywords: <span className="font-semibold">{data.keywords.length}</span></p>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-gray-50 border-b">
                          <th className="text-left p-3 font-semibold text-sm text-gray-700">Keyword</th>
                          <th className="text-left p-3 font-semibold text-sm text-gray-700">Intent</th>
                          <th className="text-center p-3 font-semibold text-sm text-gray-700">Buyer Intent</th>
                          <th className="text-center p-3 font-semibold text-sm text-gray-700">Search Volume</th>
                          <th className="text-left p-3 font-semibold text-sm text-gray-700">Interest Categories</th>
                        </tr>
                      </thead>
                      <tbody>
                        {data.keywords.map((keyword, idx) => (
                          <tr key={idx} className="border-b hover:bg-gray-50">
                            <td className="p-3">
                              <span className="font-semibold text-gray-900">{keyword.keyword}</span>
                            </td>
                            <td className="p-3">
                              <span className={`px-2 py-1 rounded text-xs font-medium ${
                                keyword.intent === 'transactional' ? 'bg-green-100 text-green-700' :
                                keyword.intent === 'commercial' ? 'bg-blue-100 text-blue-700' :
                                keyword.intent === 'navigational' ? 'bg-purple-100 text-purple-700' :
                                'bg-gray-100 text-gray-700'
                              }`}>
                                {keyword.intent}
                              </span>
                            </td>
                            <td className="p-3 text-center">
                              <div className="flex items-center justify-center gap-2">
                                <span className="font-semibold text-gray-900">{keyword.buyerIntent}%</span>
                                <div className="w-24 bg-gray-200 rounded-full h-2">
                                  <div 
                                    className={`h-2 rounded-full ${
                                      keyword.buyerIntent >= 70 ? 'bg-green-500' :
                                      keyword.buyerIntent >= 50 ? 'bg-yellow-500' :
                                      'bg-red-500'
                                    }`}
                                    style={{ width: `${keyword.buyerIntent}%` }}
                                  />
                                </div>
                              </div>
                            </td>
                            <td className="p-3 text-center">
                              <span className="font-semibold text-gray-900">{keyword.searchVolume.toLocaleString()}</span>
                            </td>
                            <td className="p-3">
                              <div className="flex flex-wrap gap-1">
                                {keyword.interestCategories.slice(0, 3).map((interest, i) => (
                                  <span key={i} className="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-200">
                                    {interest}
                                  </span>
                                ))}
                                {keyword.interestCategories.length > 3 && (
                                  <span className="text-xs text-gray-500">+{keyword.interestCategories.length - 3} more</span>
                                )}
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </>
              )}
            </div>
          )}

          {/* Locations Tab */}
          {selectedTab === 'locations' && (
            <div>
              {data.locations.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <MapPin className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                  <p className="text-lg font-semibold mb-2">No Location Data Available</p>
                  <p className="text-sm">Location analytics will appear here once visitors start browsing from different locations.</p>
                </div>
              ) : (
                <>
                  <div className="mb-4 flex items-center justify-between">
                    <p className="text-sm text-gray-600">Total Locations: <span className="font-semibold">{data.locations.length}</span></p>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-gray-50 border-b">
                          <th className="text-left p-3 font-semibold text-sm text-gray-700">Location</th>
                          <th className="text-left p-3 font-semibold text-sm text-gray-700">Type</th>
                          <th className="text-center p-3 font-semibold text-sm text-gray-700">Traffic</th>
                          <th className="text-center p-3 font-semibold text-sm text-gray-700">Engagement</th>
                          <th className="text-center p-3 font-semibold text-sm text-gray-700">Return Rate</th>
                          <th className="text-center p-3 font-semibold text-sm text-gray-700">Conversion Rate</th>
                          <th className="text-center p-3 font-semibold text-sm text-gray-700">Market Value</th>
                          <th className="text-right p-3 font-semibold text-sm text-gray-700">Recommended Budget</th>
                        </tr>
                      </thead>
                      <tbody>
                        {data.locations.map((location, idx) => (
                          <tr key={idx} className="border-b hover:bg-gray-50">
                            <td className="p-3">
                              <span className="font-semibold text-gray-900">{location.location}</span>
                            </td>
                            <td className="p-3">
                              <span className="text-xs text-gray-500 capitalize bg-gray-100 px-2 py-1 rounded">
                                {location.locationType}
                              </span>
                            </td>
                            <td className="p-3 text-center">
                              <span className="font-semibold text-gray-900">{location.traffic.toLocaleString()}</span>
                            </td>
                            <td className="p-3 text-center">
                              <div className="flex items-center justify-center gap-2">
                                <span className="font-semibold text-gray-900">{location.engagementScore.toFixed(1)}</span>
                                <div className="w-16 bg-gray-200 rounded-full h-2">
                                  <div 
                                    className={`h-2 rounded-full ${
                                      location.engagementScore >= 70 ? 'bg-green-500' :
                                      location.engagementScore >= 50 ? 'bg-yellow-500' :
                                      'bg-red-500'
                                    }`}
                                    style={{ width: `${location.engagementScore}%` }}
                                  />
                                </div>
                              </div>
                            </td>
                            <td className="p-3 text-center">
                              <span className="font-semibold text-gray-900">{location.returnVisitorRate.toFixed(1)}%</span>
                            </td>
                            <td className="p-3 text-center">
                              <span className="font-semibold text-gray-900">{location.conversionRate.toFixed(1)}%</span>
                            </td>
                            <td className="p-3 text-center">
                              <span className={`px-2 py-1 rounded text-xs font-medium ${
                                location.marketValue === 'high' ? 'bg-green-100 text-green-700' :
                                location.marketValue === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                                'bg-red-100 text-red-700'
                              }`}>
                                {location.marketValue.toUpperCase()}
                              </span>
                            </td>
                            <td className="p-3 text-right">
                              <span className="font-semibold text-gray-900">Rp {location.recommendedBudget.toLocaleString('id-ID')}</span>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </>
              )}
            </div>
          )}

          {/* Devices Tab */}
          {selectedTab === 'devices' && (
            <div>
              {data.devices.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <Smartphone className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                  <p className="text-lg font-semibold mb-2">No Device Data Available</p>
                  <p className="text-sm">Device analytics will appear here once visitors start browsing from different devices.</p>
                </div>
              ) : (
                <>
                  <div className="mb-4 flex items-center justify-between">
                    <p className="text-sm text-gray-600">Total Devices: <span className="font-semibold">{data.devices.length}</span></p>
                  </div>
                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-gray-50 border-b">
                          <th className="text-left p-3 font-semibold text-sm text-gray-700">Device</th>
                          <th className="text-left p-3 font-semibold text-sm text-gray-700">Brand / Model</th>
                          <th className="text-center p-3 font-semibold text-sm text-gray-700">Purchasing Power</th>
                          <th className="text-center p-3 font-semibold text-sm text-gray-700">Avg Price</th>
                          <th className="text-center p-3 font-semibold text-sm text-gray-700">Audience Size</th>
                          <th className="text-center p-3 font-semibold text-sm text-gray-700">Avg Engagement</th>
                        </tr>
                      </thead>
                      <tbody>
                        {data.devices.map((device, idx) => (
                          <tr key={idx} className="border-b hover:bg-gray-50">
                            <td className="p-3">
                              <span className="font-semibold text-gray-900 capitalize">{device.deviceType}</span>
                            </td>
                            <td className="p-3">
                              <div className="flex flex-col">
                                {device.deviceBrand && (
                                  <span className="text-sm font-medium text-gray-900">{device.deviceBrand}</span>
                                )}
                                {device.deviceModel && (
                                  <span className="text-xs text-gray-500">{device.deviceModel}</span>
                                )}
                                {!device.deviceBrand && !device.deviceModel && (
                                  <span className="text-xs text-gray-400">-</span>
                                )}
                              </div>
                            </td>
                            <td className="p-3 text-center">
                              <span className={`px-2 py-1 rounded text-xs font-medium ${
                                device.purchasingPower === 'high_class' || device.purchasingPower === 'high' ? 'bg-purple-100 text-purple-700' :
                                device.purchasingPower === 'menengah' || device.purchasingPower === 'medium' ? 'bg-yellow-100 text-yellow-700' :
                                device.purchasingPower === 'retail' || device.purchasingPower === 'low' ? 'bg-gray-100 text-gray-700' :
                                'bg-red-100 text-red-700'
                              }`}>
                                {device.purchasingPower === 'high_class' ? 'HIGH CLASS' :
                                 device.purchasingPower === 'menengah' ? 'MENENGAH' :
                                 device.purchasingPower === 'retail' ? 'RETAIL' :
                                 device.purchasingPower.toUpperCase()}
                              </span>
                            </td>
                            <td className="p-3 text-center">
                              {device.avgPrice ? (
                                <span className="font-semibold text-gray-900">Rp {device.avgPrice.toLocaleString('id-ID')}</span>
                              ) : (
                                <span className="text-gray-400">-</span>
                              )}
                            </td>
                            <td className="p-3 text-center">
                              {device.minPrice && device.maxPrice ? (
                                <span className="text-xs text-gray-600">
                                  Rp {device.minPrice.toLocaleString('id-ID')}<br/>
                                  - {device.maxPrice.toLocaleString('id-ID')}
                                </span>
                              ) : (
                                <span className="text-gray-400">-</span>
                              )}
                            </td>
                            <td className="p-3 text-center">
                              <span className="font-semibold text-gray-900">{device.audienceSize.toLocaleString()}</span>
                            </td>
                            <td className="p-3 text-center">
                              <div className="flex items-center justify-center gap-2">
                                <span className="font-semibold text-gray-900">{device.avgEngagement.toFixed(1)}</span>
                                <div className="w-16 bg-gray-200 rounded-full h-2">
                                  <div 
                                    className={`h-2 rounded-full ${
                                      device.avgEngagement >= 70 ? 'bg-green-500' :
                                      device.avgEngagement >= 50 ? 'bg-yellow-500' :
                                      'bg-red-500'
                                    }`}
                                    style={{ width: `${device.avgEngagement}%` }}
                                  />
                                </div>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </>
              )}
            </div>
          )}

          {/* Location Intelligence Tab */}
          {selectedTab === 'location-intelligence' && (
            <div>
              <div className="mb-6 flex items-center justify-between">
                <div>
                  <h2 className="text-xl font-bold mb-1">Location Intelligence Recommendations</h2>
                  <p className="text-sm text-gray-600">
                    Top 3-10 target locations for ads based on visitor distribution, engagement, and conversion signals
                  </p>
                </div>
                <button
                  onClick={() => fetchLocationRecommendations(true)}
                  disabled={loadingRecommendations}
                  className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 flex items-center gap-2"
                >
                  <RefreshCw className={`h-4 w-4 ${loadingRecommendations ? 'animate-spin' : ''}`} />
                  Recalculate
                </button>
              </div>

              {loadingRecommendations && locationRecommendations.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <RefreshCw className="h-12 w-12 mx-auto mb-4 text-gray-400 animate-spin" />
                  <p className="text-lg font-semibold mb-2">Calculating Location Intelligence...</p>
                </div>
              ) : locationRecommendations.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <MapPin className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                  <p className="text-lg font-semibold mb-2">No Location Recommendations</p>
                  <p className="text-sm mb-4">Location recommendations will appear once there is sufficient visitor data.</p>
                  <button
                    onClick={() => fetchLocationRecommendations(true)}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                  >
                    Calculate Now
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="mb-4 flex items-center justify-between">
                    <p className="text-sm text-gray-600">
                      Total Recommendations: <span className="font-semibold">{locationRecommendations.length}</span>
                    </p>
                    <div className="flex gap-2">
                      <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">
                        High: {locationRecommendations.filter(r => r.priority === 'high').length}
                      </span>
                      <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                        Medium: {locationRecommendations.filter(r => r.priority === 'medium').length}
                      </span>
                      <span className="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">
                        Test: {locationRecommendations.filter(r => r.priority === 'test').length}
                      </span>
                    </div>
                  </div>

                  <div className="overflow-x-auto">
                    <table className="w-full border-collapse">
                      <thead>
                        <tr className="bg-gray-50">
                          <th className="border border-gray-200 px-4 py-3 text-left text-sm font-semibold">Location</th>
                          <th className="border border-gray-200 px-4 py-3 text-left text-sm font-semibold">Type</th>
                          <th className="border border-gray-200 px-4 py-3 text-left text-sm font-semibold">Priority</th>
                          <th className="border border-gray-200 px-4 py-3 text-left text-sm font-semibold">Visitors</th>
                          <th className="border border-gray-200 px-4 py-3 text-left text-sm font-semibold">Engagement</th>
                          <th className="border border-gray-200 px-4 py-3 text-left text-sm font-semibold">Conversion</th>
                          <th className="border border-gray-200 px-4 py-3 text-left text-sm font-semibold">Weighted Score</th>
                          <th className="border border-gray-200 px-4 py-3 text-left text-sm font-semibold">Budget</th>
                          <th className="border border-gray-200 px-4 py-3 text-left text-sm font-semibold">Est. Reach</th>
                          <th className="border border-gray-200 px-4 py-3 text-left text-sm font-semibold">Est. Conversions</th>
                          <th className="border border-gray-200 px-4 py-3 text-left text-sm font-semibold">Confidence</th>
                        </tr>
                      </thead>
                      <tbody>
                        {locationRecommendations.map((rec) => (
                          <tr key={rec.id} className="hover:bg-gray-50">
                            <td className="border border-gray-200 px-4 py-3">
                              <div className="font-semibold">{rec.location}</div>
                              {rec.country && (
                                <div className="text-xs text-gray-500">
                                  {[rec.country, rec.region, rec.city].filter(Boolean).join(', ')}
                                </div>
                              )}
                            </td>
                            <td className="border border-gray-200 px-4 py-3">
                              <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded capitalize">
                                {rec.locationType}
                              </span>
                            </td>
                            <td className="border border-gray-200 px-4 py-3">
                              <span
                                className={`text-xs px-2 py-1 rounded font-medium ${
                                  rec.priority === 'high'
                                    ? 'bg-green-100 text-green-700'
                                    : rec.priority === 'medium'
                                    ? 'bg-yellow-100 text-yellow-700'
                                    : 'bg-gray-100 text-gray-700'
                                }`}
                              >
                                {rec.priority.toUpperCase()}
                              </span>
                            </td>
                            <td className="border border-gray-200 px-4 py-3 text-sm">{rec.visitorCount}</td>
                            <td className="border border-gray-200 px-4 py-3">
                              <div className="flex items-center gap-2">
                                <div className="flex-1 bg-gray-200 rounded-full h-2">
                                  <div
                                    className={`h-2 rounded-full ${
                                      rec.engagementScore >= 70
                                        ? 'bg-green-500'
                                        : rec.engagementScore >= 40
                                        ? 'bg-yellow-500'
                                        : 'bg-red-500'
                                    }`}
                                    style={{ width: `${rec.engagementScore}%` }}
                                  />
                                </div>
                                <span className="text-xs text-gray-600 w-10 text-right">{rec.engagementScore}</span>
                              </div>
                            </td>
                            <td className="border border-gray-200 px-4 py-3">
                              <div className="flex items-center gap-2">
                                <div className="flex-1 bg-gray-200 rounded-full h-2">
                                  <div
                                    className={`h-2 rounded-full ${
                                      rec.conversionSignal >= 70
                                        ? 'bg-green-500'
                                        : rec.conversionSignal >= 40
                                        ? 'bg-yellow-500'
                                        : 'bg-red-500'
                                    }`}
                                    style={{ width: `${rec.conversionSignal}%` }}
                                  />
                                </div>
                                <span className="text-xs text-gray-600 w-10 text-right">{rec.conversionSignal}</span>
                              </div>
                            </td>
                            <td className="border border-gray-200 px-4 py-3">
                              <div className="flex items-center gap-2">
                                <div className="flex-1 bg-gray-200 rounded-full h-2">
                                  <div
                                    className={`h-2 rounded-full ${
                                      rec.weightedScore >= 70
                                        ? 'bg-purple-500'
                                        : rec.weightedScore >= 40
                                        ? 'bg-yellow-500'
                                        : 'bg-gray-500'
                                    }`}
                                    style={{ width: `${rec.weightedScore}%` }}
                                  />
                                </div>
                                <span className="text-xs font-semibold text-gray-900 w-10 text-right">{rec.weightedScore}</span>
                              </div>
                            </td>
                            <td className="border border-gray-200 px-4 py-3 text-sm">
                              Rp {rec.recommendedBudget.toLocaleString('id-ID')}
                            </td>
                            <td className="border border-gray-200 px-4 py-3 text-sm">{rec.estimatedReach.toLocaleString()}</td>
                            <td className="border border-gray-200 px-4 py-3 text-sm">{rec.estimatedConversions}</td>
                            <td className="border border-gray-200 px-4 py-3">
                              <div className="flex items-center gap-2">
                                <div className="flex-1 bg-gray-200 rounded-full h-2">
                                  <div
                                    className={`h-2 rounded-full ${
                                      rec.confidence >= 70
                                        ? 'bg-green-500'
                                        : rec.confidence >= 40
                                        ? 'bg-yellow-500'
                                        : 'bg-red-500'
                                    }`}
                                    style={{ width: `${rec.confidence}%` }}
                                  />
                                </div>
                                <span className="text-xs text-gray-600 w-10 text-right">{rec.confidence}%</span>
                              </div>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>

                  {/* Detailed View for Top Recommendations */}
                  <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                    {locationRecommendations.slice(0, 4).map((rec) => (
                      <div key={rec.id} className="border rounded-lg p-4 hover:shadow-md transition">
                        <div className="flex items-start justify-between mb-3">
                          <div>
                            <h3 className="font-semibold text-lg">{rec.location}</h3>
                            <p className="text-sm text-gray-600 capitalize">{rec.locationType}</p>
                          </div>
                          <span
                            className={`text-xs px-2 py-1 rounded font-medium ${
                              rec.priority === 'high'
                                ? 'bg-green-100 text-green-700'
                                : rec.priority === 'medium'
                                ? 'bg-yellow-100 text-yellow-700'
                                : 'bg-gray-100 text-gray-700'
                            }`}
                          >
                            {rec.priority.toUpperCase()}
                          </span>
                        </div>

                        <div className="grid grid-cols-2 gap-3 mb-3">
                          <div>
                            <p className="text-xs text-gray-500">Visitors</p>
                            <p className="font-bold">{rec.visitorCount}</p>
                          </div>
                          <div>
                            <p className="text-xs text-gray-500">Weighted Score</p>
                            <p className="font-bold">{rec.weightedScore}</p>
                          </div>
                          <div>
                            <p className="text-xs text-gray-500">Engagement</p>
                            <p className="font-bold">{rec.engagementScore}</p>
                          </div>
                          <div>
                            <p className="text-xs text-gray-500">Conversion</p>
                            <p className="font-bold">{rec.conversionSignal}</p>
                          </div>
                        </div>

                        {rec.topKeywords.length > 0 && (
                          <div className="mb-3">
                            <p className="text-xs text-gray-500 mb-1">Top Keywords</p>
                            <div className="flex flex-wrap gap-1">
                              {rec.topKeywords.slice(0, 3).map((kw, idx) => (
                                <span key={idx} className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                  {kw}
                                </span>
                              ))}
                            </div>
                          </div>
                        )}

                        <div className="border-t pt-3">
                          <p className="text-xs text-gray-500 mb-1">Recommended Budget</p>
                          <p className="font-bold text-lg">Rp {rec.recommendedBudget.toLocaleString('id-ID')}</p>
                          <p className="text-xs text-gray-500 mt-1">
                            Est. {rec.estimatedConversions} conversions from {rec.estimatedReach.toLocaleString()} reach
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Keyword Intent Tab */}
          {selectedTab === 'keyword-intent' && (
            <div>
              <div className="mb-6 flex items-center justify-between">
                <div>
                  <h2 className="text-xl font-bold mb-1">Keyword Intent & Interest Mapping</h2>
                  <p className="text-sm text-gray-600">
                    Analyze keyword intent and map to platform interests (Facebook, Google, TikTok)
                  </p>
                </div>
                <button
                  onClick={fetchKeywordIntentMappings}
                  disabled={loadingIntentMappings}
                  className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 flex items-center gap-2"
                >
                  <RefreshCw className={`h-4 w-4 ${loadingIntentMappings ? 'animate-spin' : ''}`} />
                  Refresh
                </button>
              </div>

              {/* Analyze New Keyword */}
              <div className="mb-6 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <h3 className="text-sm font-semibold mb-3">Analyze New Keyword</h3>
                <div className="flex gap-2">
                  <input
                    type="text"
                    value={analyzeKeyword}
                    onChange={(e) => setAnalyzeKeyword(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && analyzeKeywordIntent()}
                    placeholder="Enter keyword (e.g., 'pestisida', 'pupuk organik')"
                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500"
                  />
                  <button
                    onClick={analyzeKeywordIntent}
                    disabled={loadingIntentMappings || !analyzeKeyword.trim()}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <Brain className="h-4 w-4" />
                    Analyze
                  </button>
                </div>
              </div>

              {loadingIntentMappings && keywordIntentMappings.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <RefreshCw className="h-12 w-12 mx-auto mb-4 text-gray-400 animate-spin" />
                  <p className="text-lg font-semibold mb-2">Loading Keyword Intent Mappings...</p>
                </div>
              ) : keywordIntentMappings.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <Brain className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                  <p className="text-lg font-semibold mb-2">No Keyword Intent Mappings</p>
                  <p className="text-sm mb-4">Analyze keywords to see intent detection and platform interest mappings.</p>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="mb-4 flex items-center justify-between">
                    <p className="text-sm text-gray-600">
                      Total Mappings: <span className="font-semibold">{keywordIntentMappings.length}</span>
                    </p>
                    <div className="flex gap-2">
                      <span className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                        Informational: {keywordIntentMappings.filter(m => m.inferredIntent === 'informational').length}
                      </span>
                      <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                        Commercial: {keywordIntentMappings.filter(m => m.inferredIntent === 'commercial').length}
                      </span>
                      <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">
                        Transactional: {keywordIntentMappings.filter(m => m.inferredIntent === 'transactional').length}
                      </span>
                    </div>
                  </div>

                  <div className="space-y-4">
                    {keywordIntentMappings.map((mapping) => (
                      <div key={mapping.keyword} className="border rounded-lg p-4 hover:shadow-md transition">
                        <div className="flex items-start justify-between mb-3">
                          <div>
                            <h3 className="font-semibold text-lg">{mapping.keyword}</h3>
                            <p className="text-xs text-gray-500">
                              Source: {mapping.source} {mapping.apiProvider && `(${mapping.apiProvider})`}
                            </p>
                          </div>
                          <div className="text-right">
                            <span
                              className={`text-xs px-2 py-1 rounded font-medium ${
                                mapping.inferredIntent === 'transactional'
                                  ? 'bg-green-100 text-green-700'
                                  : mapping.inferredIntent === 'commercial'
                                  ? 'bg-yellow-100 text-yellow-700'
                                  : mapping.inferredIntent === 'informational'
                                  ? 'bg-blue-100 text-blue-700'
                                  : 'bg-gray-100 text-gray-700'
                              }`}
                            >
                              {mapping.inferredIntent.toUpperCase()}
                            </span>
                            <div className="mt-2">
                              <div className="text-sm font-semibold">{mapping.intentConfidence}%</div>
                              <div className="text-xs text-gray-500">Intent Confidence</div>
                            </div>
                          </div>
                        </div>

                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                          <div>
                            <p className="text-xs text-gray-500">Semantic Score</p>
                            <div className="flex items-center gap-2">
                              <div className="flex-1 bg-gray-200 rounded-full h-2">
                                <div
                                  className={`h-2 rounded-full ${
                                    mapping.semanticScore >= 70 ? 'bg-green-500' : mapping.semanticScore >= 40 ? 'bg-yellow-500' : 'bg-red-500'
                                  }`}
                                  style={{ width: `${mapping.semanticScore}%` }}
                                />
                              </div>
                              <span className="text-xs text-gray-600">{mapping.semanticScore}</span>
                            </div>
                          </div>
                          <div>
                            <p className="text-xs text-gray-500">Behavior Score</p>
                            <div className="flex items-center gap-2">
                              <div className="flex-1 bg-gray-200 rounded-full h-2">
                                <div
                                  className={`h-2 rounded-full ${
                                    mapping.behaviorScore >= 70 ? 'bg-green-500' : mapping.behaviorScore >= 40 ? 'bg-yellow-500' : 'bg-red-500'
                                  }`}
                                  style={{ width: `${mapping.behaviorScore}%` }}
                                />
                              </div>
                              <span className="text-xs text-gray-600">{mapping.behaviorScore}</span>
                            </div>
                          </div>
                          <div>
                            <p className="text-xs text-gray-500">Overall Confidence</p>
                            <div className="flex items-center gap-2">
                              <div className="flex-1 bg-gray-200 rounded-full h-2">
                                <div
                                  className={`h-2 rounded-full ${
                                    mapping.overallConfidence >= 70 ? 'bg-purple-500' : mapping.overallConfidence >= 40 ? 'bg-yellow-500' : 'bg-gray-500'
                                  }`}
                                  style={{ width: `${mapping.overallConfidence}%` }}
                                />
                              </div>
                              <span className="text-xs font-semibold text-gray-900">{mapping.overallConfidence}%</span>
                            </div>
                          </div>
                          <div>
                            <p className="text-xs text-gray-500">Search Volume</p>
                            <p className="font-semibold">{mapping.searchVolume?.toLocaleString() || 'N/A'}</p>
                          </div>
                        </div>

                        {/* Platform Interests */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                          {mapping.facebookInterests && mapping.facebookInterests.length > 0 && (
                            <div className="border rounded p-2 bg-blue-50">
                              <p className="text-xs font-semibold mb-1 text-blue-700">Facebook Interests</p>
                              <div className="space-y-1">
                                {mapping.facebookInterests.slice(0, 3).map((interest: any, idx: number) => (
                                  <div key={idx} className="text-xs">
                                    <span className="font-medium">{interest.interestName}</span>
                                    <span className="text-gray-500"> ({interest.relevanceScore})</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                          {mapping.googleInterests && mapping.googleInterests.length > 0 && (
                            <div className="border rounded p-2 bg-red-50">
                              <p className="text-xs font-semibold mb-1 text-red-700">Google Interests</p>
                              <div className="space-y-1">
                                {mapping.googleInterests.slice(0, 3).map((interest: any, idx: number) => (
                                  <div key={idx} className="text-xs">
                                    <span className="font-medium">{interest.interestName}</span>
                                    <span className="text-gray-500"> ({interest.relevanceScore})</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                          {mapping.tiktokInterests && mapping.tiktokInterests.length > 0 && (
                            <div className="border rounded p-2 bg-pink-50">
                              <p className="text-xs font-semibold mb-1 text-pink-700">TikTok Interests</p>
                              <div className="space-y-1">
                                {mapping.tiktokInterests.slice(0, 3).map((interest: any, idx: number) => (
                                  <div key={idx} className="text-xs">
                                    <span className="font-medium">{interest.interestName}</span>
                                    <span className="text-gray-500"> ({interest.relevanceScore})</span>
                                  </div>
                                ))}
                              </div>
                            </div>
                          )}
                        </div>

                        {/* Synonyms & Related Keywords */}
                        {(mapping.synonyms.length > 0 || mapping.relatedKeywords.length > 0) && (
                          <div className="border-t pt-3">
                            {mapping.synonyms.length > 0 && (
                              <div className="mb-2">
                                <p className="text-xs text-gray-500 mb-1">Synonyms:</p>
                                <div className="flex flex-wrap gap-1">
                                  {mapping.synonyms.slice(0, 5).map((syn: string, idx: number) => (
                                    <span key={idx} className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                      {syn}
                                    </span>
                                  ))}
                                </div>
                              </div>
                            )}
                            {mapping.relatedKeywords.length > 0 && (
                              <div>
                                <p className="text-xs text-gray-500 mb-1">Related Keywords:</p>
                                <div className="flex flex-wrap gap-1">
                                  {mapping.relatedKeywords.slice(0, 5).map((rel: string, idx: number) => (
                                    <span key={idx} className="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">
                                      {rel}
                                    </span>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {/* Behavior Data */}
                        {mapping.behaviorData && mapping.behaviorData.visitCount > 0 && (
                          <div className="border-t mt-3 pt-3">
                            <p className="text-xs text-gray-500 mb-2">Behavior Data ({mapping.behaviorData.visitCount} visits):</p>
                            <div className="grid grid-cols-2 md:grid-cols-5 gap-2 text-xs">
                              <div>
                                <p className="text-gray-500">Time on Page</p>
                                <p className="font-semibold">{mapping.behaviorData.avgTimeOnPage}s</p>
                              </div>
                              <div>
                                <p className="text-gray-500">Scroll Depth</p>
                                <p className="font-semibold">{mapping.behaviorData.scrollDepth}%</p>
                              </div>
                              <div>
                                <p className="text-gray-500">Bounce Rate</p>
                                <p className="font-semibold">{mapping.behaviorData.bounceRate.toFixed(1)}%</p>
                              </div>
                              <div>
                                <p className="text-gray-500">Conversion Rate</p>
                                <p className="font-semibold">{mapping.behaviorData.conversionRate.toFixed(2)}%</p>
                              </div>
                              <div>
                                <p className="text-gray-500">CTA Clicks</p>
                                <p className="font-semibold">{mapping.behaviorData.ctaClicks}</p>
                              </div>
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Audience Clusters Tab */}
          {selectedTab === 'audience-clusters' && (
            <div>
              <div className="mb-6 flex items-center justify-between">
                <div>
                  <h2 className="text-xl font-bold mb-1">Audience Clusters</h2>
                  <p className="text-sm text-gray-600">
                    Dynamic visitor clusters based on intent, category, behavior, and device segment
                  </p>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => fetchAudienceClusters()}
                    disabled={loadingClusters}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <RefreshCw className={`h-4 w-4 ${loadingClusters ? 'animate-spin' : ''}`} />
                    Refresh
                  </button>
                  <button
                    onClick={async () => {
                      setLoadingClusters(true);
                      try {
                        const response = await fetch('/api/admin/ads/audience-clusters?regenerate=true&days=30');
                        const result = await response.json();
                        if (response.ok) {
                          setAudienceClusters(result.clusters || []);
                          if (result.clusters && result.clusters.length > 0) {
                            alert(`Regenerated ${result.clusters.length} audience clusters`);
                          } else {
                            alert(result.message || 'No clusters generated. Insufficient data or tables not found.');
                          }
                        } else {
                          alert(result.message || result.error || 'Failed to regenerate clusters');
                        }
                      } catch (error: any) {
                        alert(error.message || 'Failed to regenerate clusters');
                      } finally {
                        setLoadingClusters(false);
                      }
                    }}
                    disabled={loadingClusters}
                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <Zap className="h-4 w-4" />
                    Regenerate
                  </button>
                </div>
              </div>

              {loadingClusters && audienceClusters.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <RefreshCw className="h-12 w-12 mx-auto mb-4 text-gray-400 animate-spin" />
                  <p className="text-lg font-semibold mb-2">Loading Audience Clusters...</p>
                </div>
              ) : audienceClusters.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <Users className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                  <p className="text-lg font-semibold mb-2">No Audience Clusters</p>
                  <p className="text-sm mb-4">Generate clusters to see visitor segments with ad angle recommendations.</p>
                  <button
                    onClick={async () => {
                      setLoadingClusters(true);
                      try {
                        const response = await fetch('/api/admin/ads/audience-clusters?regenerate=true&days=30');
                        const result = await response.json();
                        if (response.ok) {
                          setAudienceClusters(result.clusters || []);
                          if (result.clusters && result.clusters.length > 0) {
                            alert(`Generated ${result.clusters.length} audience clusters`);
                          } else {
                            alert(result.message || 'No clusters generated. Insufficient data or tables not found.');
                          }
                        } else {
                          alert(result.message || result.error || 'Failed to generate clusters');
                        }
                      } catch (error: any) {
                        alert(error.message || 'Failed to generate clusters');
                      } finally {
                        setLoadingClusters(false);
                      }
                    }}
                    disabled={loadingClusters}
                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400"
                  >
                    Generate Clusters
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="mb-4 flex items-center justify-between">
                    <p className="text-sm text-gray-600">
                      Total Clusters: <span className="font-semibold">{audienceClusters.length}</span>
                    </p>
                    <div className="flex gap-2">
                      <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">
                        High Quality: {audienceClusters.filter((c: any) => c.qualityScore >= 70).length}
                      </span>
                      <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                        Medium: {audienceClusters.filter((c: any) => c.qualityScore >= 40 && c.qualityScore < 70).length}
                      </span>
                    </div>
                  </div>

                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                    {audienceClusters.map((cluster: any) => (
                      <div key={cluster.id} className="border rounded-lg p-4 hover:shadow-md transition">
                        <div className="flex items-start justify-between mb-3">
                          <div>
                            <h3 className="font-semibold text-lg">{cluster.clusterName}</h3>
                            <p className="text-xs text-gray-500">ID: {cluster.clusterId}</p>
                          </div>
                          <div className="text-right">
                            <div className="text-sm font-semibold">{cluster.qualityScore}</div>
                            <div className="text-xs text-gray-500">Quality Score</div>
                          </div>
                        </div>

                        {/* Characteristics */}
                        <div className="mb-3 space-y-2">
                          <div>
                            <p className="text-xs text-gray-500 mb-1">Keyword Intents:</p>
                            <div className="flex flex-wrap gap-1">
                              {cluster.characteristics.keywordIntents.slice(0, 3).map((intent: string, idx: number) => (
                                <span key={idx} className={`text-xs px-2 py-1 rounded ${
                                  intent === 'transactional' ? 'bg-green-100 text-green-700' :
                                  intent === 'commercial' ? 'bg-yellow-100 text-yellow-700' :
                                  intent === 'informational' ? 'bg-blue-100 text-blue-700' :
                                  'bg-gray-100 text-gray-700'
                                }`}>
                                  {intent}
                                </span>
                              ))}
                            </div>
                          </div>

                          <div>
                            <p className="text-xs text-gray-500 mb-1">Page Categories:</p>
                            <div className="flex flex-wrap gap-1">
                              {cluster.characteristics.pageCategories.slice(0, 3).map((cat: string, idx: number) => (
                                <span key={idx} className="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">
                                  {cat}
                                </span>
                              ))}
                            </div>
                          </div>

                          <div>
                            <p className="text-xs text-gray-500 mb-1">Device Segments:</p>
                            <div className="flex flex-wrap gap-1">
                              {cluster.characteristics.deviceSegments.map((dev: string, idx: number) => (
                                <span key={idx} className="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">
                                  {dev}
                                </span>
                              ))}
                            </div>
                          </div>
                        </div>

                        {/* Metrics */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3 text-xs">
                          <div>
                            <p className="text-gray-500">Visitors</p>
                            <p className="font-semibold">{cluster.visitorCount}</p>
                          </div>
                          <div>
                            <p className="text-gray-500">Engagement</p>
                            <p className="font-semibold">{cluster.avgEngagement.toFixed(1)}</p>
                          </div>
                          <div>
                            <p className="text-gray-500">Conversion</p>
                            <p className="font-semibold">{cluster.conversionRate.toFixed(2)}%</p>
                          </div>
                          <div>
                            <p className="text-gray-500">Stability</p>
                            <p className="font-semibold">{cluster.stabilityScore}%</p>
                          </div>
                        </div>

                        {/* Behavior Data */}
                        <div className="mb-3 p-2 bg-gray-50 rounded text-xs">
                          <p className="font-semibold mb-1">Behavior:</p>
                          <div className="grid grid-cols-2 gap-2">
                            <div>Time: {cluster.characteristics.behaviors.avgTimeOnPage}s</div>
                            <div>Scroll: {cluster.characteristics.behaviors.scrollDepth}%</div>
                            <div>Bounce: {cluster.characteristics.behaviors.bounceRate.toFixed(1)}%</div>
                            <div>CTA: {cluster.characteristics.behaviors.ctaClickRate.toFixed(2)}%</div>
                          </div>
                        </div>

                        {/* Ad Angles */}
                        <div className="border-t pt-3">
                          <p className="text-xs font-semibold mb-2">Recommended Ad Angles:</p>
                          <div className="space-y-2">
                            {cluster.adAngles.slice(0, 2).map((angle: any, idx: number) => (
                              <div key={idx} className="p-2 bg-blue-50 rounded border border-blue-200">
                                <div className="flex items-start justify-between mb-1">
                                  <span className="text-xs font-semibold text-blue-700">{angle.angle}</span>
                                  <span className="text-xs text-blue-600">{angle.confidence}%</span>
                                </div>
                                <p className="text-xs font-medium text-gray-900 mb-1">{angle.headline}</p>
                                <p className="text-xs text-gray-600 mb-1">{angle.description}</p>
                                <span className="text-xs bg-blue-200 text-blue-800 px-2 py-0.5 rounded">{angle.cta}</span>
                              </div>
                            ))}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Device Segmentation Tab */}
          {selectedTab === 'device-segmentation' && (
            <div>
              <div className="mb-6 flex items-center justify-between">
                <div>
                  <h2 className="text-xl font-bold mb-1">Device Segmentation & Behavior Insights</h2>
                  <p className="text-sm text-gray-600">
                    Automatic device classification with copywriting style, positioning, and bidding strategy recommendations
                  </p>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => fetchDeviceInsights()}
                    disabled={loadingDeviceInsights}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <RefreshCw className={`h-4 w-4 ${loadingDeviceInsights ? 'animate-spin' : ''}`} />
                    Refresh
                  </button>
                  <button
                    onClick={async () => {
                      setLoadingDeviceInsights(true);
                      try {
                        const response = await fetch('/api/admin/ads/device-segmentation?regenerate=true&days=30');
                        const result = await response.json();
                        if (response.ok) {
                          setDeviceInsights(result.insights || []);
                          if (result.insights && result.insights.length > 0) {
                            alert(`Regenerated ${result.insights.length} device insights`);
                          } else {
                            alert(result.message || 'No insights generated. Insufficient data or tables not found.');
                          }
                        } else {
                          alert(result.message || result.error || 'Failed to regenerate device insights');
                        }
                      } catch (error: any) {
                        alert(error.message || 'Failed to regenerate device insights');
                      } finally {
                        setLoadingDeviceInsights(false);
                      }
                    }}
                    disabled={loadingDeviceInsights}
                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <Zap className="h-4 w-4" />
                    Regenerate
                  </button>
                </div>
              </div>

              {loadingDeviceInsights && deviceInsights.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <RefreshCw className="h-12 w-12 mx-auto mb-4 text-gray-400 animate-spin" />
                  <p className="text-lg font-semibold mb-2">Loading Device Insights...</p>
                </div>
              ) : deviceInsights.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <Smartphone className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                  <p className="text-lg font-semibold mb-2">No Device Insights</p>
                  <p className="text-sm mb-4">Generate insights to see device segmentation with recommendations.</p>
                  <button
                    onClick={async () => {
                      setLoadingDeviceInsights(true);
                      try {
                        const response = await fetch('/api/admin/ads/device-segmentation?regenerate=true&days=30');
                        const result = await response.json();
                        if (response.ok) {
                          setDeviceInsights(result.insights || []);
                          if (result.insights && result.insights.length > 0) {
                            alert(`Generated ${result.insights.length} device insights`);
                          } else {
                            alert(result.message || 'No insights generated. Insufficient data or tables not found.');
                          }
                        } else {
                          alert(result.message || result.error || 'Failed to generate insights');
                        }
                      } catch (error: any) {
                        alert(error.message || 'Failed to generate insights');
                      } finally {
                        setLoadingDeviceInsights(false);
                      }
                    }}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                  >
                    Generate Insights
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="mb-4 flex items-center justify-between">
                    <p className="text-sm text-gray-600">
                      Total Devices: <span className="font-semibold">{deviceInsights.length}</span>
                    </p>
                    <div className="flex gap-2">
                      <span className="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded">
                        Retail: {deviceInsights.filter((i: any) => i.priceSegment === 'retail_price_sensitive').length}
                      </span>
                      <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                        Middle: {deviceInsights.filter((i: any) => i.priceSegment === 'middle_consumptive').length}
                      </span>
                      <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">
                        Premium: {deviceInsights.filter((i: any) => i.priceSegment === 'premium_lifestyle').length}
                      </span>
                    </div>
                  </div>

                  <div className="space-y-4">
                    {deviceInsights.map((insight: any) => (
                      <div key={insight.id} className="border rounded-lg p-4 hover:shadow-md transition">
                        <div className="flex items-start justify-between mb-3">
                          <div>
                            <h3 className="font-semibold text-lg">
                              {insight.deviceBrand} {insight.deviceModel || ''} ({insight.deviceType})
                            </h3>
                            <p className="text-xs text-gray-500">
                              Avg Price: Rp {insight.avgPrice.toLocaleString('id-ID')}
                            </p>
                          </div>
                          <div className="text-right">
                            <span
                              className={`text-xs px-2 py-1 rounded font-medium ${
                                insight.priceSegment === 'premium_lifestyle'
                                  ? 'bg-green-100 text-green-700'
                                  : insight.priceSegment === 'middle_consumptive'
                                  ? 'bg-yellow-100 text-yellow-700'
                                  : 'bg-orange-100 text-orange-700'
                              }`}
                            >
                              {insight.priceSegment === 'premium_lifestyle' ? 'Premium' :
                               insight.priceSegment === 'middle_consumptive' ? 'Middle' : 'Retail'}
                            </span>
                            <div className="mt-2">
                              <div className="text-sm font-semibold">{insight.confidence}%</div>
                              <div className="text-xs text-gray-500">Confidence</div>
                            </div>
                          </div>
                        </div>

                        {/* Metrics */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3 text-xs">
                          <div>
                            <p className="text-gray-500">Visitors</p>
                            <p className="font-semibold">{insight.visitorCount}</p>
                          </div>
                          <div>
                            <p className="text-gray-500">Engagement</p>
                            <p className="font-semibold">{insight.avgEngagement.toFixed(1)}</p>
                          </div>
                          <div>
                            <p className="text-gray-500">Conversion</p>
                            <p className="font-semibold">{insight.conversionRate.toFixed(2)}%</p>
                          </div>
                          <div>
                            <p className="text-gray-500">CTA Rate</p>
                            <p className="font-semibold">{insight.ctaClickRate.toFixed(2)}%</p>
                          </div>
                        </div>

                        {/* Copywriting Style */}
                        <div className="mb-3 p-3 bg-blue-50 rounded border border-blue-200">
                          <p className="text-xs font-semibold mb-2 text-blue-700">Copywriting Style:</p>
                          <p className="text-xs text-gray-700 mb-2">
                            <strong>Tone:</strong> {insight.copywritingStyle.tone}
                          </p>
                          <div className="mb-2">
                            <p className="text-xs font-medium text-gray-700 mb-1">Key Messages:</p>
                            <div className="flex flex-wrap gap-1">
                              {insight.copywritingStyle.messaging.slice(0, 3).map((msg: string, idx: number) => (
                                <span key={idx} className="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                                  {msg}
                                </span>
                              ))}
                            </div>
                          </div>
                          <div className="mb-2">
                            <p className="text-xs font-medium text-gray-700 mb-1">Key Words:</p>
                            <div className="flex flex-wrap gap-1">
                              {insight.copywritingStyle.keyWords.slice(0, 5).map((kw: string, idx: number) => (
                                <span key={idx} className="text-xs bg-white text-gray-600 px-2 py-0.5 rounded border">
                                  {kw}
                                </span>
                              ))}
                            </div>
                          </div>
                          {insight.copywritingStyle.examples.length > 0 && (
                            <div>
                              <p className="text-xs font-medium text-gray-700 mb-1">Example:</p>
                              <p className="text-xs text-gray-600 italic">{insight.copywritingStyle.examples[0]}</p>
                            </div>
                          )}
                        </div>

                        {/* Product Positioning */}
                        <div className="mb-3 p-3 bg-purple-50 rounded border border-purple-200">
                          <p className="text-xs font-semibold mb-2 text-purple-700">Product Positioning:</p>
                          <p className="text-xs font-medium text-gray-900 mb-1">{insight.productPositioning.positioning}</p>
                          <p className="text-xs text-gray-700 mb-2">{insight.productPositioning.valueProposition}</p>
                          <div className="grid grid-cols-2 gap-2">
                            <div>
                              <p className="text-xs font-medium text-gray-700 mb-1">Features:</p>
                              <ul className="text-xs text-gray-600 list-disc list-inside space-y-0.5">
                                {insight.productPositioning.features.slice(0, 3).map((f: string, idx: number) => (
                                  <li key={idx}>{f}</li>
                                ))}
                              </ul>
                            </div>
                            <div>
                              <p className="text-xs font-medium text-gray-700 mb-1">Benefits:</p>
                              <ul className="text-xs text-gray-600 list-disc list-inside space-y-0.5">
                                {insight.productPositioning.benefits.slice(0, 3).map((b: string, idx: number) => (
                                  <li key={idx}>{b}</li>
                                ))}
                              </ul>
                            </div>
                          </div>
                        </div>

                        {/* Bidding Strategy */}
                        <div className="p-3 bg-green-50 rounded border border-green-200">
                          <p className="text-xs font-semibold mb-2 text-green-700">Bidding Strategy:</p>
                          <p className="text-xs text-gray-700 mb-2">{insight.biddingStrategy.strategy}</p>
                          <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                            <div>
                              <p className="text-gray-500">Recommended Bid</p>
                              <p className="font-semibold">Rp {insight.biddingStrategy.recommendedBid.toLocaleString('id-ID')}</p>
                            </div>
                            <div>
                              <p className="text-gray-500">Bid Multiplier</p>
                              <p className="font-semibold">{insight.biddingStrategy.bidMultiplier}x</p>
                            </div>
                            <div>
                              <p className="text-gray-500">Daily Budget</p>
                              <p className="font-semibold">Rp {insight.biddingStrategy.budgetRecommendation.toLocaleString('id-ID')}</p>
                            </div>
                            <div>
                              <p className="text-gray-500">Targeting</p>
                              <div className="flex flex-wrap gap-1">
                                {insight.biddingStrategy.targeting.slice(0, 2).map((t: string, idx: number) => (
                                  <span key={idx} className="text-xs bg-white text-gray-600 px-1 py-0.5 rounded">
                                    {t}
                                  </span>
                                ))}
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Auto Generate Tab */}
          {selectedTab === 'auto-generate' && (
            <div>
              <div className="mb-6 flex items-center justify-between">
                <div>
                  <h2 className="text-xl font-bold mb-1">Auto Generate Ad Sets</h2>
                  <p className="text-sm text-gray-600">
                    Ready-to-use ad sets generated from all intelligence engines
                  </p>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => fetchAutoGeneratedAdSets()}
                    disabled={loadingAutoGenerate}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <RefreshCw className={`h-4 w-4 ${loadingAutoGenerate ? 'animate-spin' : ''}`} />
                    Refresh
                  </button>
                  <button
                    onClick={async () => {
                      setLoadingAutoGenerate(true);
                      try {
                        const response = await fetch('/api/admin/ads/auto-generate?generate=true&days=30');
                        const result = await response.json();
                        if (response.ok) {
                          setAutoGeneratedAdSets(result.adSets || []);
                          if (result.adSets && result.adSets.length > 0) {
                            alert(`Generated ${result.adSets.length} ready-to-use ad sets`);
                          } else {
                            alert(result.message || 'No ad sets generated. Insufficient data or tables not found.');
                          }
                        } else {
                          alert(result.message || result.error || 'Failed to generate ad sets');
                        }
                      } catch (error: any) {
                        alert(error.message || 'Failed to generate ad sets');
                      } finally {
                        setLoadingAutoGenerate(false);
                      }
                    }}
                    disabled={loadingAutoGenerate}
                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <Zap className="h-4 w-4" />
                    Generate New
                  </button>
                  <button
                    onClick={async () => {
                      try {
                        const response = await fetch('/api/admin/ads/auto-generate?export=json');
                        if (response.ok) {
                          const data = await response.json();
                          const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                          const url = window.URL.createObjectURL(blob);
                          const a = document.createElement('a');
                          a.href = url;
                          a.download = `auto-adsets-${new Date().toISOString().split('T')[0]}.json`;
                          document.body.appendChild(a);
                          a.click();
                          window.URL.revokeObjectURL(url);
                          document.body.removeChild(a);
                          alert('Ad sets exported to JSON');
                        } else {
                          alert('Failed to export JSON');
                        }
                      } catch (error) {
                        alert('Failed to export JSON');
                      }
                    }}
                    disabled={loadingAutoGenerate || autoGeneratedAdSets.length === 0}
                    className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <Download className="h-4 w-4" />
                    Export JSON
                  </button>
                  <button
                    onClick={async () => {
                      try {
                        const response = await fetch('/api/admin/ads/auto-generate?export=csv');
                        if (response.ok) {
                          const blob = await response.blob();
                          const url = window.URL.createObjectURL(blob);
                          const a = document.createElement('a');
                          a.href = url;
                          a.download = `auto-adsets-${new Date().toISOString().split('T')[0]}.csv`;
                          document.body.appendChild(a);
                          a.click();
                          window.URL.revokeObjectURL(url);
                          document.body.removeChild(a);
                          alert('Ad sets exported to CSV');
                        } else {
                          alert('Failed to export CSV');
                        }
                      } catch (error) {
                        alert('Failed to export CSV');
                      }
                    }}
                    disabled={loadingAutoGenerate || autoGeneratedAdSets.length === 0}
                    className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <Download className="h-4 w-4" />
                    Export CSV
                  </button>
                </div>
              </div>

              {loadingAutoGenerate && autoGeneratedAdSets.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <RefreshCw className="h-12 w-12 mx-auto mb-4 text-gray-400 animate-spin" />
                  <p className="text-lg font-semibold mb-2">Generating Ad Sets...</p>
                </div>
              ) : autoGeneratedAdSets.length === 0 ? (
                <div className="text-center py-12 text-gray-500">
                  <Target className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                  <p className="text-lg font-semibold mb-2">No Auto-Generated Ad Sets</p>
                  <p className="text-sm mb-4">Generate ad sets to see ready-to-use configurations for Ads Manager.</p>
                  <button
                    onClick={async () => {
                      setLoadingAutoGenerate(true);
                      try {
                        const response = await fetch('/api/admin/ads/auto-generate?generate=true&days=30');
                        if (response.ok) {
                          const result = await response.json();
                          setAutoGeneratedAdSets(result.adSets || []);
                          alert(`Generated ${result.adSets.length} ad sets`);
                        }
                      } catch (error) {
                        alert('Failed to generate ad sets');
                      } finally {
                        setLoadingAutoGenerate(false);
                      }
                    }}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                  >
                    Generate Ad Sets
                  </button>
                </div>
              ) : (
                <div className="space-y-4">
                  <div className="mb-4 flex items-center justify-between">
                    <p className="text-sm text-gray-600">
                      Total Ad Sets: <span className="font-semibold">{autoGeneratedAdSets.length}</span>
                    </p>
                    <div className="flex gap-2">
                      <span className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded">
                        High Quality: {autoGeneratedAdSets.filter((a: any) => a.qualityScore >= 70).length}
                      </span>
                      <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-1 rounded">
                        Medium: {autoGeneratedAdSets.filter((a: any) => a.qualityScore >= 40 && a.qualityScore < 70).length}
                      </span>
                    </div>
                  </div>

                  <div className="space-y-4">
                    {autoGeneratedAdSets.map((adSet: any) => (
                      <div key={adSet.id} className="border rounded-lg p-4 hover:shadow-md transition">
                        <div className="flex items-start justify-between mb-3">
                          <div className="flex-1">
                            <h3 className="font-semibold text-lg mb-1">{adSet.adSetName}</h3>
                            <p className="text-xs text-gray-500">ID: {adSet.adSetId}</p>
                          </div>
                          <div className="flex items-center gap-3">
                            <span className={`text-xs px-2 py-1 rounded font-medium ${
                              adSet.platform === 'all' ? 'bg-purple-100 text-purple-700' :
                              adSet.platform === 'google' ? 'bg-blue-100 text-blue-700' :
                              adSet.platform === 'facebook' ? 'bg-indigo-100 text-indigo-700' :
                              'bg-pink-100 text-pink-700'
                            }`}>
                              {adSet.platform.toUpperCase()}
                            </span>
                            <div className="text-right">
                              <div className="text-sm font-semibold">{adSet.qualityScore}</div>
                              <div className="text-xs text-gray-500">Quality</div>
                            </div>
                            <div className="text-right">
                              <div className="text-sm font-semibold">{adSet.confidence}%</div>
                              <div className="text-xs text-gray-500">Confidence</div>
                            </div>
                          </div>
                        </div>

                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
                          {/* Targeting */}
                          <div className="p-3 bg-blue-50 rounded border border-blue-200">
                            <p className="text-xs font-semibold mb-2 text-blue-700">Targeting:</p>
                            <div className="space-y-1 text-xs">
                              <div>
                                <span className="font-medium">Locations:</span>{' '}
                                <span className="text-gray-600">{adSet.targetLocations.map((l: any) => l.location).join(', ')}</span>
                              </div>
                              <div>
                                <span className="font-medium">Device Types:</span>{' '}
                                <span className="text-gray-600">{adSet.devicePlacement.deviceTypes.join(', ')}</span>
                              </div>
                              <div>
                                <span className="font-medium">Keywords:</span>{' '}
                                <span className="text-gray-600">{adSet.keywordTargeting.keywords.slice(0, 3).join(', ')}...</span>
                              </div>
                            </div>
                          </div>

                          {/* Interests */}
                          <div className="p-3 bg-purple-50 rounded border border-purple-200">
                            <p className="text-xs font-semibold mb-2 text-purple-700">Interests:</p>
                            <div className="space-y-1 text-xs">
                              {adSet.interests.facebook && adSet.interests.facebook.length > 0 && (
                                <div>
                                  <span className="font-medium">Facebook:</span>{' '}
                                  <span className="text-gray-600">{adSet.interests.facebook.slice(0, 2).map((i: any) => i.interestName).join(', ')}</span>
                                </div>
                              )}
                              {adSet.interests.google && adSet.interests.google.length > 0 && (
                                <div>
                                  <span className="font-medium">Google:</span>{' '}
                                  <span className="text-gray-600">{adSet.interests.google.slice(0, 2).map((i: any) => i.interestName).join(', ')}</span>
                                </div>
                              )}
                              {adSet.interests.tiktok && adSet.interests.tiktok.length > 0 && (
                                <div>
                                  <span className="font-medium">TikTok:</span>{' '}
                                  <span className="text-gray-600">{adSet.interests.tiktok.slice(0, 2).map((i: any) => i.interestName).join(', ')}</span>
                                </div>
                              )}
                            </div>
                          </div>
                        </div>

                        {/* Creative */}
                        <div className="p-3 bg-green-50 rounded border border-green-200 mb-3">
                          <p className="text-xs font-semibold mb-2 text-green-700">Creative Recommendations:</p>
                          <div className="space-y-1 text-xs">
                            <div>
                              <span className="font-medium">Headline:</span>{' '}
                              <span className="text-gray-700">{adSet.copyAngle.headline}</span>
                            </div>
                            <div>
                              <span className="font-medium">Description:</span>{' '}
                              <span className="text-gray-700">{adSet.copyAngle.description}</span>
                            </div>
                            <div>
                              <span className="font-medium">CTA:</span>{' '}
                              <span className="text-gray-700">{adSet.ctaRecommendation.cta}</span>
                              {adSet.ctaRecommendation.variants.length > 0 && (
                                <span className="text-gray-500 ml-2">
                                  (Variants: {adSet.ctaRecommendation.variants.slice(0, 2).join(', ')})
                                </span>
                              )}
                            </div>
                            <div>
                              <span className="font-medium">Tone:</span>{' '}
                              <span className="text-gray-600">{adSet.copyAngle.tone}</span>
                            </div>
                          </div>
                        </div>

                        {/* Budget & Performance */}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                          <div>
                            <p className="text-gray-500">Daily Budget</p>
                            <p className="font-semibold">Rp {adSet.budgetRecommendation.toLocaleString('id-ID')}</p>
                          </div>
                          <div>
                            <p className="text-gray-500">Bid</p>
                            <p className="font-semibold">Rp {adSet.bidRecommendation.toLocaleString('id-ID')}</p>
                          </div>
                          <div>
                            <p className="text-gray-500">Est. CTR</p>
                            <p className="font-semibold">{adSet.expectedPerformance.estimatedCTR}%</p>
                          </div>
                          <div>
                            <p className="text-gray-500">Est. Conversions</p>
                            <p className="font-semibold">{adSet.expectedPerformance.estimatedConversions}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}

          {/* Unified Smart Ads Tab */}
          {selectedTab === 'unified' && (
            <div>
              <div className="mb-6 flex items-center justify-between">
                <div>
                  <h2 className="text-xl font-bold mb-1">Unified Smart Ads Engine</h2>
                  <p className="text-sm text-gray-600">
                    DATA-DRIVEN, AUTO-LEARNING, PROFIT-ORIENTED - All engines combined
                  </p>
                </div>
                <div className="flex gap-2">
                  <button
                    onClick={() => fetchUnifiedAds()}
                    disabled={loadingUnified}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <RefreshCw className={`h-4 w-4 ${loadingUnified ? 'animate-spin' : ''}`} />
                    Refresh
                  </button>
                  <button
                    onClick={async () => {
                      setLoadingUnified(true);
                      try {
                        const response = await fetch('/api/admin/engines/unified?action=generate&days=30&prioritizeProfit=true');
                        const result = await response.json();
                        if (response.ok) {
                          setUnifiedAds(result);
                          if (result.adSets && result.adSets.length > 0) {
                            alert(`Generated ${result.adSets.length} profit-oriented ad sets`);
                          } else {
                            alert(result.message || 'No ad sets generated. Insufficient data or tables not found.');
                          }
                        } else {
                          alert(result.message || result.error || 'Failed to generate unified Smart Ads');
                        }
                      } catch (error: any) {
                        alert(error.message || 'Failed to generate unified Smart Ads');
                      } finally {
                        setLoadingUnified(false);
                      }
                    }}
                    disabled={loadingUnified}
                    className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 flex items-center gap-2"
                  >
                    <Zap className="h-4 w-4" />
                    Generate Unified
                  </button>
                </div>
              </div>

              {loadingUnified && !unifiedAds ? (
                <div className="text-center py-12 text-gray-500">
                  <RefreshCw className="h-12 w-12 mx-auto mb-4 text-gray-400 animate-spin" />
                  <p className="text-lg font-semibold mb-2">Generating Unified Smart Ads...</p>
                </div>
              ) : !unifiedAds ? (
                <div className="text-center py-12 text-gray-500">
                  <Target className="h-12 w-12 mx-auto mb-4 text-gray-400" />
                  <p className="text-lg font-semibold mb-2">No Unified Smart Ads Data</p>
                  <p className="text-sm mb-4">Generate unified Smart Ads to see profit-oriented ad sets from all engines.</p>
                  <button
                    onClick={async () => {
                      setLoadingUnified(true);
                      try {
                        const response = await fetch('/api/admin/engines/unified?action=generate&days=30&prioritizeProfit=true');
                        if (response.ok) {
                          const result = await response.json();
                          setUnifiedAds(result);
                          alert(`Generated ${result.adSets.length} ad sets`);
                        }
                      } catch (error) {
                        alert('Failed to generate');
                      } finally {
                        setLoadingUnified(false);
                      }
                    }}
                    className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700"
                  >
                    Generate Unified Smart Ads
                  </button>
                </div>
              ) : (
                <div className="space-y-6">
                  {/* Profit Summary */}
                  <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                      <p className="text-sm text-gray-600 mb-1">Estimated Revenue</p>
                      <p className="text-2xl font-bold text-green-700">
                        Rp {unifiedAds.profit?.estimatedTotalRevenue?.toLocaleString('id-ID') || '0'}
                      </p>
                    </div>
                    <div className="bg-red-50 border border-red-200 rounded-lg p-4">
                      <p className="text-sm text-gray-600 mb-1">Estimated Cost</p>
                      <p className="text-2xl font-bold text-red-700">
                        Rp {unifiedAds.profit?.estimatedTotalCost?.toLocaleString('id-ID') || '0'}
                      </p>
                    </div>
                    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                      <p className="text-sm text-gray-600 mb-1">Estimated ROI</p>
                      <p className="text-2xl font-bold text-blue-700">
                        {unifiedAds.profit?.estimatedROI?.toFixed(2) || '0'}%
                      </p>
                    </div>
                    <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                      <p className="text-sm text-gray-600 mb-1">Total Ad Sets</p>
                      <p className="text-2xl font-bold text-purple-700">
                        {unifiedAds.quality?.totalGenerated || 0}
                      </p>
                    </div>
                  </div>

                  {/* Quality Metrics */}
                  <div className="bg-white border rounded-lg p-4">
                    <h3 className="font-semibold mb-3">Quality Metrics</h3>
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                      <div>
                        <p className="text-sm text-gray-600">High Quality</p>
                        <p className="text-lg font-bold text-green-600">{unifiedAds.quality?.highQuality || 0}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-600">Medium Quality</p>
                        <p className="text-lg font-bold text-yellow-600">{unifiedAds.quality?.mediumQuality || 0}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-600">Avg Quality Score</p>
                        <p className="text-lg font-bold text-blue-600">{unifiedAds.quality?.averageQualityScore?.toFixed(1) || '0'}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-600">Total Generated</p>
                        <p className="text-lg font-bold text-gray-900">{unifiedAds.quality?.totalGenerated || 0}</p>
                      </div>
                    </div>
                  </div>

                  {/* Insights */}
                  {unifiedAds.insights && (
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                      {unifiedAds.insights.highPerformingInterests?.length > 0 && (
                        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                          <h3 className="font-semibold mb-2 text-green-700">High-Performing Interests</h3>
                          <p className="text-2xl font-bold text-green-700">{unifiedAds.insights.highPerformingInterests.length}</p>
                        </div>
                      )}
                      {unifiedAds.insights.newPotentialLocations?.length > 0 && (
                        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                          <h3 className="font-semibold mb-2 text-blue-700">New Potential Locations</h3>
                          <p className="text-2xl font-bold text-blue-700">{unifiedAds.insights.newPotentialLocations.length}</p>
                        </div>
                      )}
                      {unifiedAds.insights.topConvertingDevices?.length > 0 && (
                        <div className="bg-purple-50 border border-purple-200 rounded-lg p-4">
                          <h3 className="font-semibold mb-2 text-purple-700">Top Converting Devices</h3>
                          <p className="text-2xl font-bold text-purple-700">{unifiedAds.insights.topConvertingDevices.length}</p>
                        </div>
                      )}
                    </div>
                  )}

                  {/* Ad Sets List */}
                  <div>
                    <h3 className="text-lg font-semibold mb-3">Generated Ad Sets ({unifiedAds.adSets?.length || 0})</h3>
                    <div className="space-y-4">
                      {unifiedAds.adSets?.slice(0, 10).map((adSet: any, idx: number) => (
                        <div key={idx} className="border rounded-lg p-4 hover:shadow-md transition">
                          <div className="flex items-start justify-between mb-3">
                            <div className="flex-1">
                              <h4 className="font-semibold">{adSet.adSetName || adSet.name || `Ad Set ${idx + 1}`}</h4>
                            </div>
                            <div className="text-right">
                              <div className="text-sm font-semibold">{adSet.qualityScore || 0}</div>
                              <div className="text-xs text-gray-500">Quality</div>
                            </div>
                          </div>
                          {adSet.expectedPerformance && (
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                              <div>
                                <p className="text-gray-500">Est. CTR</p>
                                <p className="font-semibold">{adSet.expectedPerformance.estimatedCTR || 0}%</p>
                              </div>
                              <div>
                                <p className="text-gray-500">Est. Conversions</p>
                                <p className="font-semibold">{adSet.expectedPerformance.estimatedConversions || 0}</p>
                              </div>
                              <div>
                                <p className="text-gray-500">Budget</p>
                                <p className="font-semibold">Rp {(adSet.budgetRecommendation || 0).toLocaleString('id-ID')}</p>
                              </div>
                              <div>
                                <p className="text-gray-500">Bid</p>
                                <p className="font-semibold">Rp {(adSet.bidRecommendation || 0).toLocaleString('id-ID')}</p>
                              </div>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    </div>
  );
}

